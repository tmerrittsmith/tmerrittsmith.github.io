<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>US CFPB classification task</title>
  <meta name="description" content="import pandas as pdfrom sklearn.decomposition import LatentDirichletAllocationfrom sklearn.feature_extraction.text import CountVectorizer, TfidfVectorizerimp...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/2020/07/01/us-cfpb-classification-task.html">
  <link rel="alternate" type="application/rss+xml" title="TMS - Data Person" href="http://localhost:4000/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">TMS - Data Person</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
          <a class="page-link" href="/downloads/t_merritt_smith_cv.pdf">CV</a>
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">US CFPB classification task</h1>
    <p class="post-meta"><time datetime="2020-07-01T00:00:00+01:00" itemprop="datePublished">Jul 1, 2020</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">LatentDirichletAllocation</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">CountVectorizer</span><span class="p">,</span> <span class="n">TfidfVectorizer</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
</code></pre></div></div>

<h1 id="us-consumer-financial-protection-bureau">US Consumer FInancial Protection Bureau</h1>

<p>As an intermediary, the CFPB receives a large number of complaints. To help the CFPB better manage them, they would like to reduce the complaints logged to those that are most likely to be successful. To help them to do this, they would like to be able to indicate to a consumer whether it is likely that their complaint will be accepted. This will help the consumer to decide whether they wish to go through the complaints process, and will reduce the number of complaints logged.</p>

<p>Therefore, your objective is to build a classification model that can be used to:</p>

<ol>
  <li>Determine whether a consumer’s complaint will be accepted and whether they are likely to receive relief.</li>
  <li>Help the CFPB understand what factors affect how a company responds to the complaints that it receives.</li>
</ol>

<p>This investigation is split into three sections:</p>

<h3 id="exploratory-data-analysis"><a href="#eda">Exploratory Data Analysis</a></h3>

<h3 id="classification"><a href="#clf">Classification</a></h3>

<h3 id="conclusion"><a href="#fin">Conclusion</a></h3>

<p>On my <a href="www.github.com/tmerrittsmith">github</a> page, I have another notebook where I tried some neural net approaches. However, the performance wasn’t as good as Logistic Regression used here.</p>

<p><a id="eda"></a></p>

<h2 id="exploratory-data-analysis-1">Exploratory Data Analysis</h2>

<p>In this section, we perform some basic data cleaning, and plot the data to understand some of the features.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## if you haven't got the data, you can download it from here</span>
<span class="c">## I've inluded a sample in this repo, just so you can see the code running</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'Consumer_complaints.csv'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">' '</span><span class="p">,</span><span class="s">'_'</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'-'</span><span class="p">,</span><span class="s">''</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'?'</span><span class="p">,</span><span class="s">''</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Index(['date_received', 'product', 'subproduct', 'issue', 'subissue',
       'consumer_complaint_narrative', 'company_public_response', 'company',
       'state', 'zip_code', 'tags', 'consumer_consent_provided',
       'submitted_via', 'date_sent_to_company', 'company_response_to_consumer',
       'timely_response', 'consumer_disputed', 'complaint_id'],
      dtype='object')
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">extract_year_month_date</span><span class="p">(</span><span class="n">datetime_series</span><span class="p">,</span> <span class="n">dateformat</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">is_string</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c">## take a datetime series and return a dataframe containing the year, month, </span>
    <span class="c">## day and dayofweek</span>
    <span class="k">if</span> <span class="n">dateformat</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">infer_date_format</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">infer_date_format</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">if</span> <span class="n">is_string</span><span class="p">:</span>
        <span class="n">datetime_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">datetime_series</span><span class="p">,</span> <span class="n">infer_datetime_format</span><span class="o">=</span><span class="n">infer_date_format</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">dateformat</span><span class="p">)</span>
<span class="c">#         print(datetime_series)</span>
    <span class="n">colname</span> <span class="o">=</span> <span class="n">datetime_series</span><span class="o">.</span><span class="n">name</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">datetime_series</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span>\
                           <span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">colname</span><span class="p">:</span><span class="s">'year_{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colname</span><span class="p">)})</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">datetime_series</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span>\
                            <span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">colname</span><span class="p">:</span><span class="s">'month_{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colname</span><span class="p">)})</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">datetime_series</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span>\
                          <span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">colname</span><span class="p">:</span><span class="s">'day_{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colname</span><span class="p">)})</span>
    <span class="n">dayofweek</span> <span class="o">=</span> <span class="n">datetime_series</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">dayofweek</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span>\
                                <span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">colname</span><span class="p">:</span><span class="s">'dayofweek_{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colname</span><span class="p">)})</span>
    <span class="k">return</span> <span class="n">year</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dayofweek</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extract_year_month_date</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'date_received'</span><span class="p">],</span> <span class="n">is_string</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">dateformat</span><span class="o">=</span><span class="s">"</span><span class="si">%</span><span class="s">d/</span><span class="si">%</span><span class="s">M/</span><span class="si">%</span><span class="s">Y"</span><span class="p">))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extract_year_month_date</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'date_sent_to_company'</span><span class="p">],</span> <span class="n">is_string</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">dateformat</span><span class="o">=</span><span class="s">"</span><span class="si">%</span><span class="s">d/</span><span class="si">%</span><span class="s">M/</span><span class="si">%</span><span class="s">Y"</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Look at the total complaints for different products, by year </span>
<span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'product'</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">year_date_received</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>year_date_received</th>
      <th>2011</th>
      <th>2012</th>
      <th>2013</th>
      <th>2014</th>
      <th>2015</th>
      <th>2016</th>
      <th>2017</th>
    </tr>
    <tr>
      <th>product</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Bank account or service</th>
      <td>0</td>
      <td>12212</td>
      <td>13388</td>
      <td>14662</td>
      <td>17140</td>
      <td>21849</td>
      <td>6956</td>
    </tr>
    <tr>
      <th>Checking or savings account</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>9947</td>
    </tr>
    <tr>
      <th>Consumer Loan</th>
      <td>0</td>
      <td>1986</td>
      <td>3117</td>
      <td>5457</td>
      <td>7888</td>
      <td>9602</td>
      <td>3558</td>
    </tr>
    <tr>
      <th>Credit card</th>
      <td>1260</td>
      <td>15353</td>
      <td>13105</td>
      <td>13974</td>
      <td>17300</td>
      <td>21066</td>
      <td>7132</td>
    </tr>
    <tr>
      <th>Credit card or prepaid card</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>11921</td>
    </tr>
    <tr>
      <th>Credit reporting</th>
      <td>0</td>
      <td>1873</td>
      <td>14380</td>
      <td>29239</td>
      <td>34273</td>
      <td>44081</td>
      <td>16578</td>
    </tr>
    <tr>
      <th>Credit reporting, credit repair services, or other personal consumer reports</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>59186</td>
    </tr>
    <tr>
      <th>Debt collection</th>
      <td>0</td>
      <td>0</td>
      <td>11069</td>
      <td>39148</td>
      <td>39757</td>
      <td>40492</td>
      <td>41101</td>
    </tr>
    <tr>
      <th>Money transfer, virtual currency, or money service</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2213</td>
    </tr>
    <tr>
      <th>Money transfers</th>
      <td>0</td>
      <td>0</td>
      <td>559</td>
      <td>1169</td>
      <td>1619</td>
      <td>1567</td>
      <td>440</td>
    </tr>
    <tr>
      <th>Mortgage</th>
      <td>1276</td>
      <td>38109</td>
      <td>49401</td>
      <td>42962</td>
      <td>42353</td>
      <td>41471</td>
      <td>26622</td>
    </tr>
    <tr>
      <th>Other financial service</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>116</td>
      <td>312</td>
      <td>466</td>
      <td>165</td>
    </tr>
    <tr>
      <th>Payday loan</th>
      <td>0</td>
      <td>0</td>
      <td>194</td>
      <td>1706</td>
      <td>1586</td>
      <td>1567</td>
      <td>493</td>
    </tr>
    <tr>
      <th>Payday loan, title loan, or personal loan</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2245</td>
    </tr>
    <tr>
      <th>Prepaid card</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>336</td>
      <td>1784</td>
      <td>1250</td>
      <td>449</td>
    </tr>
    <tr>
      <th>Student loan</th>
      <td>0</td>
      <td>2840</td>
      <td>3005</td>
      <td>4283</td>
      <td>4501</td>
      <td>8087</td>
      <td>15896</td>
    </tr>
    <tr>
      <th>Vehicle loan or lease</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2873</td>
    </tr>
    <tr>
      <th>Virtual currency</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>7</td>
      <td>7</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## looking at the list of products, we can see that there's some unification which seems reasonable.</span>

<span class="n">remap_products</span> <span class="o">=</span> <span class="p">{</span>
     <span class="c"># product:remapped_product</span>
    <span class="s">'Credit card'</span><span class="p">:</span><span class="s">'Credit card or prepaid card'</span><span class="p">,</span>
    <span class="s">'Credit reporting, credit repair services, or other personal consumer reports'</span><span class="p">:</span><span class="s">'Credit reporting'</span><span class="p">,</span>
    <span class="s">'Money transfers'</span><span class="p">:</span><span class="s">'Money transfer, virtual currency, or money service'</span><span class="p">,</span>
    <span class="s">'Virtual currency'</span><span class="p">:</span><span class="s">'Money transfer, virtual currency, or money service'</span><span class="p">,</span>
    <span class="s">'Payday loan, title loan, or personal loan'</span><span class="p">:</span><span class="s">'Payday loan'</span><span class="p">,</span>
    <span class="s">'Prepaid card'</span><span class="p">:</span><span class="s">'Credit card or prepaid card'</span><span class="p">,</span> 
    
<span class="p">}</span>

<span class="n">df</span><span class="p">[</span><span class="s">'product'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'product'</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">remap_products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">remap_products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># unify the relief responses</span>
<span class="n">relief</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Closed with monetary relief'</span><span class="p">,</span>
             <span class="s">'Closed with non-monetary relief'</span><span class="p">,</span>
             <span class="s">'Closed with relief'</span><span class="p">]</span>

<span class="n">df</span><span class="p">[</span><span class="s">'relief_received'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">company_response_to_consumer</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">relief</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">tab</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'product'</span><span class="p">],</span><span class="n">df</span><span class="p">[</span><span class="s">'relief_received'</span><span class="p">])</span>
<span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">tab</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'bar'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Percentage company responses for each product type.'</span><span class="p">)</span>
<span class="c"># plt.tight_layout()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/images/us_cfpb/output_11_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'year_date_received'</span><span class="p">,</span><span class="s">'product'</span><span class="p">])</span><span class="o">.</span><span class="n">relief_received</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">'lower center'</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">'Annual relief rate by product'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/images/us_cfpb/output_12_0.png" alt="png" /></p>

<h4 id="company-size">Company size</h4>
<p>We observe that most companies have a very small number of complaints, while others have a very large number. Does this affect the relief rate?</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span>\
      <span class="s">"{0:.1f}</span><span class="si">% </span><span class="s">of companies do less than 100 transactions."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>\
      <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'company'</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()[</span><span class="s">'product'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span> <span class="o">/</span>\
                            <span class="n">df</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>89.4% of companies do less than 100 transactions.
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># we note that most companies are very small</span>
<span class="n">company_size</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'company'</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()[</span><span class="s">'product'</span><span class="p">]</span>
<span class="n">company_size_bin</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">company_size</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">50000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">],</span>
                          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s">'very_small'</span><span class="p">,</span> <span class="s">'small'</span><span class="p">,</span> <span class="s">'medium'</span><span class="p">,</span> <span class="s">'large'</span><span class="p">,</span> <span class="s">'very_large'</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">company_size_bin</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'company'</span><span class="p">,</span> <span class="s">'company_size'</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">company_size_bin</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'company'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">[</span><span class="s">'company_relief_rate'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'company'</span><span class="p">)</span><span class="o">.</span><span class="n">relief_received</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s">'mean'</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">df</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s">'company_relief_rate'</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s">'company_size'</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/images/us_cfpb/output_16_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># We can see that very large companies receive most complaints about bank accounts, credit reporting, and mortgages</span>
<span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'product'</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s">'company_size'</span><span class="p">])</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>company_size</th>
      <th>very_small</th>
      <th>small</th>
      <th>medium</th>
      <th>large</th>
      <th>very_large</th>
    </tr>
    <tr>
      <th>product</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Bank account or service</th>
      <td>1000</td>
      <td>6115</td>
      <td>30471</td>
      <td>21322</td>
      <td>27299</td>
    </tr>
    <tr>
      <th>Checking or savings account</th>
      <td>169</td>
      <td>655</td>
      <td>3625</td>
      <td>2559</td>
      <td>2939</td>
    </tr>
    <tr>
      <th>Consumer Loan</th>
      <td>2792</td>
      <td>9735</td>
      <td>11308</td>
      <td>4441</td>
      <td>3332</td>
    </tr>
    <tr>
      <th>Credit card or prepaid card</th>
      <td>572</td>
      <td>3801</td>
      <td>27592</td>
      <td>58072</td>
      <td>14893</td>
    </tr>
    <tr>
      <th>Credit reporting</th>
      <td>1942</td>
      <td>5515</td>
      <td>5512</td>
      <td>3934</td>
      <td>182707</td>
    </tr>
    <tr>
      <th>Debt collection</th>
      <td>36514</td>
      <td>58364</td>
      <td>57402</td>
      <td>15051</td>
      <td>4236</td>
    </tr>
    <tr>
      <th>Money transfer, virtual currency, or money service</th>
      <td>395</td>
      <td>831</td>
      <td>4960</td>
      <td>635</td>
      <td>764</td>
    </tr>
    <tr>
      <th>Mortgage</th>
      <td>7786</td>
      <td>15079</td>
      <td>58160</td>
      <td>87537</td>
      <td>73632</td>
    </tr>
    <tr>
      <th>Other financial service</th>
      <td>324</td>
      <td>182</td>
      <td>263</td>
      <td>149</td>
      <td>141</td>
    </tr>
    <tr>
      <th>Payday loan</th>
      <td>1533</td>
      <td>4194</td>
      <td>1647</td>
      <td>216</td>
      <td>201</td>
    </tr>
    <tr>
      <th>Student loan</th>
      <td>1640</td>
      <td>4858</td>
      <td>9704</td>
      <td>20787</td>
      <td>1623</td>
    </tr>
    <tr>
      <th>Vehicle loan or lease</th>
      <td>278</td>
      <td>938</td>
      <td>1128</td>
      <td>293</td>
      <td>236</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'year_date_received'</span><span class="p">,</span><span class="s">'company_size'</span><span class="p">])</span><span class="o">.</span><span class="n">relief_received</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Proportion of complaints in which relief is given </span><span class="se">\n</span><span class="s">for companies of different size, by year'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/images/us_cfpb/output_18_0.png" alt="png" /></p>

<h2 id="discussion-of-exploratory-data-analysis">Discussion of exploratory data analysis</h2>

<p>From the exploratory analysis above, we can make a few initial observations:</p>
<ul>
  <li>Credit cards and prepaid cards, credit reporting, and account services have the highest relief rates, but these are gradually decreasing year-on-year</li>
  <li>Larger companies have a higher average relief rate, but there is much greater variation in small companies.</li>
</ul>

<p><a id="clf"></a></p>

<h1 id="classification-1">Classification</h1>

<p>In this task, we are asked to build a classification model that can be used to:</p>

<ol>
  <li>Determine whether a consumer’s complaint will be accepted and whether they are likely to receive relief.</li>
  <li>Help the CFPB understand what factors affect how a company responds to the complaints that it receives.</li>
</ol>

<p>From this statement, we can begin to make plans about what sort of model to use in classification:</p>
<ul>
  <li>an interpretable model will be helpful as we will immediately gain an insight into factors affecting company response</li>
  <li>if the model is not interpretable, we will need to use some kind of model inspection or explanation technique</li>
  <li>Relevant factors may be found in the text, but also in the metadata of the complaint (product, issue, tag etc.) so we should also include these features in our model.</li>
</ul>

<h4 id="baseline">Baseline</h4>
<p>In any classification problem, it’s useful to establish a baseline for further development, and for nlp problems this is usually a bag-of-words input with a linear model - here we will try Logistic Regression, and a Linear SVC.</p>

<h4 id="data-preprocessing">Data preprocessing</h4>
<p>It is standard practice to undertake some cleaning of the text, such as removing stopwords and punctuation; from a brief glance at some samples, we can see that the complaints are anonymised using ‘xxxx’ tokens - these should also be removed. As mentioned above, a bag-of-words model is a standard approach, but we can also use Tf-Idf to give a relevance weighting to tokens within the text.</p>

<p>The following metadata features will also be included: product, issue, sub-issue, company size and tag. We will not include the actual company, as this may lead to overfitting based on the relief rate of companies in the training set, and would not generalise to new companies as they appear in the data.</p>

<p>There is a 4:1 imbalance in the data, which is not too extreme, but should be accounted for. As a minimum, the data must be stratified in the train-test split, and during model development we can explore the use of class weights and oversampling of the data.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s">'consumer_complaint_narrative'</span><span class="p">])</span>\
  <span class="o">.</span><span class="n">relief_received</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s">'consumer_complaint_narrative'</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0    0.819553
1    0.180447
Name: relief_received, dtype: float64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">CountVectorizer</span><span class="p">,</span> <span class="n">TfidfVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">LinearSVC</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">RandomizedSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="n">stats</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">31415</span><span class="p">)</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_text</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_text</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s">'consumer_complaint_narrative'</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">df_text</span><span class="o">.</span><span class="n">shape</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df_text</span><span class="p">[</span><span class="s">'consumer_complaint_narrative'</span><span class="p">]</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'xx+'</span><span class="p">,</span><span class="s">''</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_text</span><span class="o">.</span><span class="n">relief_received</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">31415</span><span class="p">)</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># baseline model for logistic regression and LinearSVC</span>
<span class="n">relief_tags</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Closed with non-monetary relief'</span><span class="p">,</span>
       <span class="s">'Closed with monetary relief'</span><span class="p">,</span><span class="s">'Closed with relief'</span><span class="p">,]</span>


<span class="n">vectorizer</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">(</span><span class="n">strip_accents</span> <span class="o">=</span> <span class="s">'unicode'</span><span class="p">,</span>
                                <span class="n">stop_words</span> <span class="o">=</span> <span class="s">'english'</span><span class="p">,</span>
                                <span class="n">lowercase</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                                <span class="n">max_df</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> 
                                <span class="n">min_df</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">X_train</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">models</span> <span class="o">=</span> <span class="p">{</span><span class="s">'lr'</span><span class="p">:</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">},</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">31415</span><span class="p">),</span> 
          <span class="s">'svc'</span><span class="p">:</span><span class="n">LinearSVC</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">},</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">31415</span><span class="p">)}</span>
<span class="n">preds</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">preds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">preds</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>

</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lr


STOP: TOTAL NO. of ITERATIONS REACHED LIMIT.

Increase the number of iterations (max_iter) or scale the data as shown in:
    https://scikit-learn.org/stable/modules/preprocessing.html.
Please also refer to the documentation for alternative solver options:
    https://scikit-learn.org/stable/modules/linear_model.html#logistic-regression
  extra_warning_msg=_LOGISTIC_SOLVER_CONVERGENCE_MSG)


              precision    recall  f1-score   support

           0       0.91      0.66      0.77     32777
           1       0.31      0.69      0.43      7217

    accuracy                           0.67     39994
   macro avg       0.61      0.68      0.60     39994
weighted avg       0.80      0.67      0.71     39994

svc
              precision    recall  f1-score   support

           0       0.89      0.74      0.81     32777
           1       0.33      0.59      0.42      7217

    accuracy                           0.71     39994
   macro avg       0.61      0.66      0.62     39994
weighted avg       0.79      0.71      0.74     39994



ConvergenceWarning: Liblinear failed to converge, increase the number of iterations.
  "the number of iterations.", ConvergenceWarning)
</code></pre></div></div>

<h4 id="leveraging-additional-meta-data">Leveraging additional meta-data</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">hstack</span>

<span class="n">ohe</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">)</span>
<span class="c"># we won't use company name, as this would lead to overfitting to individual companies</span>
<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s">'product'</span><span class="p">,</span><span class="s">'issue'</span><span class="p">,</span><span class="s">'subissue'</span><span class="p">,</span><span class="s">'company_size'</span><span class="p">]</span> 

<span class="n">X</span> <span class="o">=</span> <span class="n">df_text</span><span class="p">[[</span><span class="s">'product'</span><span class="p">,</span><span class="s">'issue'</span><span class="p">,</span><span class="s">'subissue'</span><span class="p">,</span><span class="s">'company_size'</span><span class="p">,</span><span class="s">'consumer_complaint_narrative'</span><span class="p">]]</span>
<span class="n">X</span><span class="p">[[</span><span class="s">'product'</span><span class="p">,</span><span class="s">'issue'</span><span class="p">,</span><span class="s">'subissue'</span><span class="p">]]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[[</span><span class="s">'product'</span><span class="p">,</span><span class="s">'issue'</span><span class="p">,</span><span class="s">'subissue'</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s">'none'</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_text</span><span class="o">.</span><span class="n">relief_received</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">31415</span><span class="p">)</span>

<span class="n">vectorizer_meta_data</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">()</span>
<span class="n">X_train_text</span> <span class="o">=</span> <span class="n">vectorizer_meta_data</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="s">'consumer_complaint_narrative'</span><span class="p">])</span>
<span class="n">X_test_text</span> <span class="o">=</span> <span class="n">vectorizer_meta_data</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="s">'consumer_complaint_narrative'</span><span class="p">])</span>
<span class="n">X_train_features</span> <span class="o">=</span> <span class="n">ohe</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">features</span><span class="p">],)</span>
<span class="n">X_test_features</span> <span class="o">=</span> <span class="n">ohe</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">features</span><span class="p">])</span>

<span class="n">X_train</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="n">X_train_text</span><span class="p">,</span> <span class="n">X_train_features</span><span class="p">])</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="n">X_test_text</span><span class="p">,</span> <span class="n">X_test_features</span><span class="p">])</span>



</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  self[k1] = value[k2]
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="s">'balanced'</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">31415</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ConvergenceWarning: lbfgs failed to converge (status=1):
STOP: TOTAL NO. of ITERATIONS REACHED LIMIT.

Increase the number of iterations (max_iter) or scale the data as shown in:
    https://scikit-learn.org/stable/modules/preprocessing.html.
Please also refer to the documentation for alternative solver options:
    https://scikit-learn.org/stable/modules/linear_model.html#logistic-regression
  extra_warning_msg=_LOGISTIC_SOLVER_CONVERGENCE_MSG)





LogisticRegression(C=1.0, class_weight='balanced', dual=False,
                   fit_intercept=True, intercept_scaling=1, l1_ratio=None,
                   max_iter=100, multi_class='auto', n_jobs=None, penalty='l2',
                   random_state=31415, solver='lbfgs', tol=0.0001, verbose=0,
                   warm_start=False)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">preds</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>              precision    recall  f1-score   support

           0       0.91      0.72      0.80     32777
           1       0.34      0.66      0.45      7217

    accuracy                           0.71     39994
   macro avg       0.62      0.69      0.63     39994
weighted avg       0.80      0.71      0.74     39994
</code></pre></div></div>

<h4 id="inspecting-the-logistic-regression-model">Inspecting the Logistic Regression model</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">feature_melt</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">categories</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">features</span><span class="p">,</span><span class="n">ohe</span><span class="o">.</span><span class="n">categories_</span><span class="p">):</span>
    <span class="n">melted</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
    <span class="n">feature_melt</span> <span class="o">+=</span> <span class="n">melted</span>

<span class="n">categories</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">ohe</span><span class="o">.</span><span class="n">categories_</span><span class="p">)</span>

<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">categories</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">[:,</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">categories</span><span class="p">):][</span><span class="mi">0</span><span class="p">],</span> <span class="n">feature_melt</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
<span class="n">coef_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'category'</span><span class="p">,</span> <span class="s">'coef'</span><span class="p">,</span> <span class="s">'original_feature'</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">coef_df</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s">'coef'</span><span class="p">,</span> 
           <span class="n">by</span><span class="o">=</span><span class="s">'original_feature'</span><span class="p">,</span> 
           <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
           <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">'Boxplot of coefficients for meta-data features of complaints'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/images/us_cfpb/output_31_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Display the coefficients for products</span>
<span class="n">coef_df</span><span class="p">[</span><span class="n">coef_df</span><span class="o">.</span><span class="n">original_feature</span> <span class="o">==</span> <span class="s">'product'</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s">'coef'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>category</th>
      <th>coef</th>
      <th>original_feature</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3</th>
      <td>Credit card or prepaid card</td>
      <td>0.545969</td>
      <td>product</td>
    </tr>
    <tr>
      <th>0</th>
      <td>Bank account or service</td>
      <td>0.326113</td>
      <td>product</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Checking or savings account</td>
      <td>0.225128</td>
      <td>product</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Debt collection</td>
      <td>0.0556301</td>
      <td>product</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Other financial service</td>
      <td>0.0510896</td>
      <td>product</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Consumer Loan</td>
      <td>0.0438741</td>
      <td>product</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Vehicle loan or lease</td>
      <td>-0.001235</td>
      <td>product</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Credit reporting</td>
      <td>-0.0166776</td>
      <td>product</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Money transfer, virtual currency, or money ser...</td>
      <td>-0.156185</td>
      <td>product</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Payday loan</td>
      <td>-0.386861</td>
      <td>product</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Mortgage</td>
      <td>-0.526208</td>
      <td>product</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Student loan</td>
      <td>-0.649351</td>
      <td>product</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Display the coefficients for company size</span>
<span class="n">coef_df</span><span class="p">[</span><span class="n">coef_df</span><span class="o">.</span><span class="n">original_feature</span> <span class="o">==</span> <span class="s">'company_size'</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s">'coef'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>category</th>
      <th>coef</th>
      <th>original_feature</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>381</th>
      <td>very_large</td>
      <td>0.463117</td>
      <td>company_size</td>
    </tr>
    <tr>
      <th>379</th>
      <td>medium</td>
      <td>0.136443</td>
      <td>company_size</td>
    </tr>
    <tr>
      <th>378</th>
      <td>large</td>
      <td>-0.073706</td>
      <td>company_size</td>
    </tr>
    <tr>
      <th>382</th>
      <td>very_small</td>
      <td>-0.471874</td>
      <td>company_size</td>
    </tr>
    <tr>
      <th>380</th>
      <td>small</td>
      <td>-0.542694</td>
      <td>company_size</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Display the coefficients for issues</span>
<span class="n">coef_df</span><span class="p">[</span><span class="n">coef_df</span><span class="o">.</span><span class="n">original_feature</span> <span class="o">==</span> <span class="s">'issue'</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s">'coef'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>category</th>
      <th>coef</th>
      <th>original_feature</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>156</th>
      <td>Unable to get credit report/credit score</td>
      <td>0.875798</td>
      <td>issue</td>
    </tr>
    <tr>
      <th>134</th>
      <td>Problems caused by my funds being low</td>
      <td>0.542986</td>
      <td>issue</td>
    </tr>
    <tr>
      <th>87</th>
      <td>Late fee</td>
      <td>0.3429</td>
      <td>issue</td>
    </tr>
    <tr>
      <th>46</th>
      <td>Communication tactics</td>
      <td>0.326751</td>
      <td>issue</td>
    </tr>
    <tr>
      <th>159</th>
      <td>Unauthorized transactions/trans. issues</td>
      <td>0.305247</td>
      <td>issue</td>
    </tr>
    <tr>
      <th>80</th>
      <td>Improper contact or sharing of info</td>
      <td>0.284458</td>
      <td>issue</td>
    </tr>
    <tr>
      <th>101</th>
      <td>Managing, opening, or closing account</td>
      <td>0.250215</td>
      <td>issue</td>
    </tr>
    <tr>
      <th>108</th>
      <td>Other fee</td>
      <td>0.233449</td>
      <td>issue</td>
    </tr>
    <tr>
      <th>30</th>
      <td>Billing disputes</td>
      <td>0.198935</td>
      <td>issue</td>
    </tr>
    <tr>
      <th>56</th>
      <td>Credit monitoring or identity protection</td>
      <td>0.177035</td>
      <td>issue</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">words</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">()</span>
<span class="n">word_coefs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">words</span><span class="p">,</span> <span class="n">models</span><span class="p">[</span><span class="s">'lr'</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
<span class="n">word_coefs</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'words'</span><span class="p">,</span><span class="s">'coef'</span><span class="p">]</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Display the words with largest positive coefficients</span>
<span class="k">print</span><span class="p">(</span><span class="n">word_coefs</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s">'coef'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)[:</span><span class="mi">60</span><span class="p">])</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                   words      coef
2844           jefferson   2.72214
1829             dynamic   2.29037
4377            rushcard   1.91164
1920            enhanced   1.57078
2789          interstate    1.4535
4376                rush    1.3884
3837       professionals  0.830137
1096            citigold  0.801865
5132           universal  0.792687
562   annualcreditreport  0.776771
3585            partners   0.68735
520               allied  0.623358
1019                cbna  0.613705
2586           hurricane   0.58328
1265                conn  0.560628
1256         conflicting  0.557217
4885          technology  0.530956
4185              repaye  0.526669
2435               guide  0.525563
1037       certification  0.522281
3318               multi  0.518445
281                  809  0.499301
548         amortization  0.497155
3485          operations  0.495929
1212          completing  0.493841
715             attitude  0.491621
1016             cavalry   0.48636
4607              solely  0.483301
3075                  lt  0.473938
1957                 erc  0.472124
1672            diligent  0.471448
1811             driving  0.471193
2821                  iq  0.467393
5048           triggered  0.464511
221                  580  0.458511
5210               usury  0.456739
1024              ceased  0.452705
1165            combined  0.452562
2866        jurisdiction  0.451061
3869            proposed  0.447958
2519               hipaa  0.446082
4331               rings  0.440639
5259                 vet  0.439018
4775          subsection  0.435682
4749              strict  0.434813
3480             operate  0.429676
40                 1681b  0.429669
3088                macy  0.427806
3218             midland  0.424827
4313           reversing  0.423636
689          association  0.422513
5321              warned  0.421285
3027              loaded  0.420755
2895                  ky  0.416796
4738        straightened  0.416616
581              apology  0.409819
2038            existent  0.409039
1630           desperate  0.408801
3907          punishment    0.4077
433       administration  0.406148
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">inspect_complaints</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">complaints_array</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>

        <span class="n">complaints</span> <span class="o">=</span> <span class="n">complaints_array</span><span class="p">[</span><span class="n">complaints_array</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span>\
                                     <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="bp">True</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">string</span> <span class="o">+</span> <span class="s">'</span><span class="err">\</span><span class="s">s'</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">complaints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">complaints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'n was too large, printing all available complaints.</span><span class="se">\n\n</span><span class="s">'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">complaint</span> <span class="o">=</span> <span class="n">complaints</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">complaint</span> <span class="o">=</span> <span class="n">complaint</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">'[['</span> <span class="o">+</span> <span class="n">string</span> <span class="o">+</span> <span class="s">']]'</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">complaint</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n\n\n</span><span class="s">'</span><span class="p">)</span>
            
<span class="n">inspect_complaints</span><span class="p">(</span><span class="s">'1681b'</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">consumer_complaint_narrative</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>While checking my personal credit report, I discovered an Unauthorized and Fraudulent credit inquiry made without my KNOWLEDGE or CONSENT by XXXX on or about XXXX/XXXX/2014 on TRANSUNION credit file. I did not authorized or give permission to anyone employed by this company to make any inquiry and view my credit report. XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. I am requesting that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus and have them remove the unauthorized and fraudulent hard inquiry immediately.




While checking my personal credit report, I noticed an unauthorized and fraudulent credit inquiry made by XXXX on or about XX/XX/XXXX on Transunion. I did not authorized anyone employed by this company to make any inquiry and view my credit report. XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. 
I have requested that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus immediately and have them remove the unauthorized and fraudulent hard inquiry immediately. I also requested that they remove my personal information from their records. My Social Security # is XXXX and my Date of Birth is XX/XX/XXXX in case it is needed to locate the fraudulent inquiry in their system.




While checking my personal credit report, I discovered an Unauthorized and Fraudulent credit inquiry made without my KNOWLEDGE or CONSENT by XXXX on or about XXXX/XXXX/2015 on TRANSUNION credit file. I did not authorized or give permission to anyone employed by this company to make any inquiry and view my credit report. XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. I am requesting that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus and have them remove the unauthorized and fraudulent hard inquiry immediately.




While checking my personal credit report, I noticed an unauthorized and fraudulent credit inquiry made by XX/XX/XXXX on or about XX/XX/XXXXon Transunion. I did not authorized anyone employed by this company to make any inquiry and view my credit report. XX/XX/XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. 
I have requested that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus immediately and have them remove the unauthorized and fraudulent hard inquiry immediately. I also requested that they remove my personal information from their records. My Social Security # is XXXX and my Date of Birth is XX/XX/XXXX in case it is needed to locate the fraudulent inquiry in their system.




While checking my personal credit report, I discovered an Unauthorized and Fraudulent credit inquiry made without my KNOWLEDGE or CONSENT by XXXX on or about XXXX/XXXX/2014 on TRANSUNION credit file. I did not authorized or give permission to anyone employed by this company to make any inquiry and view my credit report. XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. I am requesting that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus and have them remove the unauthorized and fraudulent hard inquiry immediately.




While checking my personal credit report, I noticed an unauthorized and fraudulent credit inquiry made by XXXX on or about XX/XX/XXXX on Transunion. I did not authorized anyone employed by this company to make any inquiry and view my credit report. XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. 
I have requested that they mail me a copy of my signed authorization form that gave them the right to view my credit within XXXX ( XXXX ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus immediately and have them remove the unauthorized and fraudulent hard inquiry immediately. I also requested that they remove my personal information from their records. My Social Security # is XXXX and my Date of Birth is XX/XX/XXXX in case it is needed to locate the fraudulent inquiry in their system.




While checking my personal credit report, I discovered an Unauthorized and Fraudulent credit inquiry made without my KNOWLEDGE or CONSENT by XXXX on or about XXXX/XXXX/2014 on TRANSUNION credit file. I did not authorized or give permission to anyone employed by this company to make any inquiry and view my credit report. XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. I am requesting that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus and have them remove the unauthorized and fraudulent hard inquiry immediately.




While checking my personal credit report, I noticed an unauthorized and fraudulent credit inquiry made by XXXX on or about XXXX/XXXX/XXXXon Transunion. I did not authorized anyone employed by this company to make any inquiry and view my credit report. XXXX XXXX XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. 
I have requested that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus immediately and have them remove the unauthorized and fraudulent hard inquiry immediately. I also requested that they remove my personal information from their records. My Social Security # is XXXX and my Date of Birth is XX/XX/XXXX in case it is needed to locate the fraudulent inquiry in their system.




While checking my personal credit report, I discovered an Unauthorized and Fraudulent credit inquiry made without my KNOWLEDGE or CONSENT by XXXX on or about XXXX/XXXX/2014 on TRANSUNION credit file. I did not authorized or give permission to anyone employed by this company to make any inquiry and view my credit report. XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. I am requesting that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus and have them remove the unauthorized and fraudulent hard inquiry immediately.




I just checked my personal credit report, just discovered an unauthorized and fraudulent credit inquiry made by XXXX on or about XXXX/XXXX/14 on TRANSUNION. I did not authorized anyone employed by this company or at this company or TRANSUNION to make any inquiry or inquiries and view or show my credit report to anyone, person, company, entity, business, co, corp or similar. XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. I have requested that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof Bearing my Signature or Request in Writing that I authorized them to view my credit report, then I am demanding that TRANSUNION remove the unauthorized and fraudulent hard credit inquiry immediately from my TRANSUNION credit file.




While checking my personal credit report, I noticed an unauthorized and fraudulent credit inquiry made by XXXX on or about XX/XX/XXXX on Transunion. I did not authorized anyone employed by this company to make any inquiry and view my credit report. XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. 
I have requested that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus immediately and have them remove the unauthorized and fraudulent hard inquiry immediately. I also requested that they remove my personal information from their records. My Social Security # is XXXX and my Date of Birth is XX/XX/XXXX in case it is needed to locate the fraudulent inquiry in their system.




I recently check my Transunion report and it shows an unauthorized Credit Inquiry made from XXXX XXXX XXXX XXXX XXXX XXXX XXXX XXXX XXXX XXXX XXXX, UT XXXX ( XXXX ) XXXX. 

While checking my personal credit report, which I acquired from [ Transunion ] noticed an inquiry made by the company on XX/XX/2017 I did not authorized anyone employed by the company to make an inquiry and view my credit report. it have violated the Fair Credit Reporting Act Section [[1681b]] ( c ) .You are not legally entitled to make the inquiry. This is a serious breach of my privacy rights. 

I request that you either mail me a copy of my signed authorization form that gave you the right to view my credit within five ( 30 ) business daysso that I can verify its validity




XXXX   XXXX  offered me a chance to receive a secured credit card with an opening deposit twice and I was denied both times. I was n't planning on applying for anything during those times as I was repairing my credit. I applied because I was allegedly pre-approved. That 's not fair to the consumer. Neither  XXXX   XXXX  nor the  XXXX  credit bureaus ( TransUnion,  XXXX , and   XXXX    ) will ho nor removing the inquiries even though I was solicited by   XXXX   XXXX  . The FACTS states inquiries can only be pulled under certain conditions and " firm '' offers a re one of those conditions. Here is a reference to the code under ( c ) ( 1 ) ( B ) ( I ) : 15 U.S. Code [[1681b]] - Permissible purposes of consumer reports ( c ) Furnishing reports in connection with credit or insurance transactions that are not initiated by consumer ( 1 ) In general A consumer reporting agency may furnish a consumer report relating to any consumer pursuant to subparagraph ( A ) or ( C ) of subsection ( a ) ( 3 ) in connection with any credit or insurance transaction that is not initiated by the consumer only if ( A ) the consumer authorizes the agency to provide such report to such person ; or ( B ) ( i ) the transaction consists of a firm offer of credit or insurance ; ( ii ) the consumer reporting agency has complied with subsection ( e ) ; ( iii ) there is not in effect an election by the consumer, made in accor  dance with subsection ( e ), to have the consumers name and address excluded from lists of names provided by the agency pursuant to this paragraph ; and ( iv ) the consumer report does not contain a date of birth that shows that the consumer has not attained the age of 21, or, if the date of birth on the consumer report shows that the consumer has not attained the age of 21, suc h consumer consents to the consumer reporting agency to such furnishing.




While checking my personal credit report, I noticed an unauthorized and fraudulent credit inquiry made by XXXX on or about XX/XX/XXXX on Transunion. I did not authorized anyone employed by this company to make any inquiry and view my credit report. XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. 
I have requested that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus immediately and have them remove the unauthorized and fraudulent hard inquiry immediately. I also requested that they remove my personal information from their records. My Social Security # is XXXX and my Date of Birth is XX/XX/XXXX in case it is needed to locate the fraudulent inquiry in their system.




Please check the attached FTC ID Theft report, there are several inquiries on my credit report, they are all listed accordingly on that report. I did not give your company permission to run my credit nor do you have any permissible purpose to run my credit.   Since it is against the FCR A, 604. Permissible purposes of consumer reports [ 15 U.S.C. [[1681b]] ] for an entity  to view a consumers credit report without a permissible purpose. I am writing to inquire as to your alleged purpose for doing so since I did not apply for any credit with your company.   This inquiry was performed under false pretenses as described in the clear language of the la w. 15 USC 1681n ( a ) ( 1 ) ( B ) wh ich states, in part, in the case of liability of a natural person for obtaining a consumer report under false pretenses or knowingly without a permissible purpose, actual damages sustained by the consumer as a result of the failure or {$1000.00}, whichever is greater ;




While checking my personal credit report, I discovered an Unauthorized and Fraudulent credit inquiry made without my KNOWLEDGE or CONSENT by XXXX on or about XXXX/XXXX/2014 on TRANSUNION credit file. I did not authorized or give permission to anyone employed by this company to make any inquiry and view my credit report. XXXX XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. I am requesting that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus and have them remove the unauthorized and fraudulent hard inquiry immediately.




While checking my personal credit report, I noticed an unauthorized and fraudulent credit inquiry made by XXXX on or about XX/XX/XXXX onTransunion. I did not authorized anyone employed by this company to make any inquiry and view my credit report. XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. 
I have requested that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus immediately and have them remove the unauthorized and fraudulent hard inquiry immediately. I also requested that they remove my personal information from their records. My Social Security # is XXXX and my Date of Birth is XX/XX/XXXX in case it is needed to locate the fraudulent inquiry in their system.




While checking my personal credit report, I noticed an unauthorized and fraudulent credit inquiry made by XXXX on or about XX/XX/XXXX on Transunion. I did not authorized anyone employed by this company to make any inquiry and view my credit report. XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. 
I have requested that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus immediately and have them remove the unauthorized and fraudulent hard inquiry immediately. I also requested that they remove my personal information from their records. My Social Security # is XXXX and my Date of Birth is XX/XX/XXXX in case it is needed to locate the fraudulent inquiry in their system.




While checking my personal credit report, I noticed an unauthorized and fraudulent credit inquiry made by XXXX on or about XX/XX/XXXX on Transunion. I did not authorized anyone employed by this company to make any inquiry and view my credit report.XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. 
I have requested that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus immediately and have them remove the unauthorized and fraudulent hard inquiry immediately. I also requested that they remove my personal information from their records. My Social Security # is XXXX and my Date of Birth is XX/XX/XXXX in case it is needed to locate the fraudulent inquiry in their system.




While checking my personal credit report, I noticed an unauthorized and fraudulent credit inquiry made by XXXX on or about XX/XX/XXXX on Transunion. I did not authorized anyone employed by this company to make any inquiry and view my credit report. XXXX has violated the Fair Credit Reporting Act Section [[1681b]] ( c ). They were not legally entitled to make this fraudulent inquiry. This is a serious breach of my privacy rights. 
I have requested that they mail me a copy of my signed authorization form that gave them the right to view my credit within five ( 5 ) business days so that I can verify its validity and advised them that if they can not provide me with proof that I authorized them to view my credit report then I am demanding that they contact the credit bureaus immediately and have them remove the unauthorized and fraudulent hard inquiry immediately. I also requested that they remove my personal information from their records. My Social Security # is XXXX and my Date of Birth is XXXX in case it is needed to locate the fraudulent inquiry in their system.
</code></pre></div></div>

<p><a id="fin"></a></p>

<h1 id="conclusions">Conclusions</h1>

<ul>
  <li>The Logistic Regression model with metadata features confirms our observations that the products most indicative of receiving relief are credit cards and prepaid cards, bank and checking accounts.</li>
  <li>The model confirms that larger companies are more likely to award relief.</li>
  <li>Inspection of complaints text using the model coefficients, reveals some specific issues:
    <ul>
      <li>The Dodds-Frank law, codes 1681b and 1681g from the US consumer laws</li>
      <li>Length of complaint may be indicative of likelihood of relief (examples)</li>
      <li>Company names are often embedded in complaints, so there is a possibility of overfitting to individual companies</li>
    </ul>
  </li>
</ul>

<h4 id="appendices">Appendices</h4>

<p><a href="#opt">Parameter Optimisation</a>
Code to optimise the logistic regression model using a randomised search.</p>

<p><a href="#thresh">Thresholding predictions</a>
The CFPB can control the level of recall and precision in the model predictions by applying a threshold against the prediction probabilities. In this way, they can understand the trade-off between the reduction in number of complaints they want to achieve using the model, and the proportion of potentially successful complaints they might miss by doing so.</p>

<p><a href="#lda">Latent Dirichlet Allocation</a>
Topic modelling is a helpful way to explore text data, and is an unsupervised method. pyLDAvis is used to visualise the output of an LDA model.</p>

<p><a id="opt"></a></p>

<h1 id="parameter-optimisation-to-get-a-strong-model">Parameter optimisation to get a strong model</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">FunctionTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfTransformer</span>

<span class="k">def</span> <span class="nf">xx_remove</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="c">## function to remove the xx blanks in strings, as this is noise</span>
    <span class="n">fixed</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'xx+'</span><span class="p">,</span><span class="s">''</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fixed</span>



<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s">'product'</span><span class="p">,</span> <span class="s">'issue'</span><span class="p">,</span> <span class="s">'sub-issue'</span><span class="p">,</span> <span class="s">'company_size'</span><span class="p">]</span>
<span class="n">text_features</span> <span class="o">=</span> <span class="s">'consumer_complaint_narrative'</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s">'ohe'</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">'scaler'</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">(</span><span class="n">with_mean</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">text_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s">'xx'</span><span class="p">,</span> <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">xx_remove</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">'vect'</span><span class="p">,</span> <span class="n">CountVectorizer</span><span class="p">(</span><span class="n">strip_accents</span> <span class="o">=</span> <span class="s">'unicode'</span><span class="p">,</span>
                                <span class="n">stop_words</span> <span class="o">=</span> <span class="s">'english'</span><span class="p">,</span>
                                <span class="n">lowercase</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">'tfidf'</span><span class="p">,</span> <span class="n">TfidfTransformer</span><span class="p">())</span>
<span class="p">])</span>



<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
<span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s">'cat'</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'text'</span><span class="p">,</span> <span class="n">text_transformer</span><span class="p">,</span> <span class="n">text_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">clf</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s">'preprocessor'</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s">'classifier'</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="p">])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'preprocessor__text__vect__max_df'</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="s">'preprocessor__text__vect__max_features'</span><span class="p">:</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">50000</span><span class="p">),</span>
    <span class="s">'preprocessor__text__vect__ngram_range'</span><span class="p">:</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>  <span class="c"># unigrams or bigrams</span>
    <span class="s">'preprocessor__text__tfidf__use_idf'</span><span class="p">:</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span>
    <span class="s">'preprocessor__text__tfidf__norm'</span><span class="p">:</span> <span class="p">(</span><span class="s">'l1'</span><span class="p">,</span> <span class="s">'l2'</span><span class="p">),</span>
    <span class="s">'preprocessor__cat__scaler'</span><span class="p">:[</span><span class="s">'passthrough'</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">(</span><span class="n">with_mean</span><span class="o">=</span><span class="bp">False</span><span class="p">)],</span>
    <span class="s">'classifier__C'</span><span class="p">:</span><span class="n">stats</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>
    <span class="s">'classifier__class_weight'</span><span class="p">:[{</span><span class="mi">1</span><span class="p">:</span><span class="n">w</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">)]</span>
<span class="p">}</span>

<span class="n">random_search</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">31415</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">random_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="p">[</span><span class="s">'f1_score'</span><span class="p">,</span><span class="s">'recall'</span><span class="p">,</span><span class="s">'precision'</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">preds</span> <span class="o">=</span> <span class="n">random_search</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">preds</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>              precision    recall  f1-score   support

           0       0.88      0.82      0.85     10647
           1       0.45      0.57      0.51      2715

    accuracy                           0.77     13362
   macro avg       0.67      0.70      0.68     13362
weighted avg       0.80      0.77      0.78     13362
</code></pre></div></div>

<h4 id="oversampling">Oversampling</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">imblearn.over_sampling</span> <span class="kn">import</span> <span class="n">SMOTE</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">smote</span> <span class="o">=</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">X_train_smote</span><span class="p">,</span> <span class="n">y_train_smote</span> <span class="o">=</span> <span class="n">smote</span><span class="o">.</span><span class="n">fit_sample</span><span class="p">(</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_smote</span><span class="p">,</span> <span class="n">y_train_smote</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">preds</span><span class="p">))</span>
</code></pre></div></div>

<p><a id="thresh"></a></p>

<h1 id="prediction-threshold">Prediction threshold</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">preds</span> <span class="o">=</span> <span class="n">randomised_search</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">preds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">))</span>
</code></pre></div></div>

<p><a id="clf"></a></p>

<p><a id="lda"></a></p>

<h1 id="lda">LDA</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">vect</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">(</span><span class="n">strip_accents</span> <span class="o">=</span> <span class="s">'unicode'</span><span class="p">,</span>
                                <span class="n">stop_words</span> <span class="o">=</span> <span class="s">'english'</span><span class="p">,</span>
                                <span class="n">lowercase</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                                <span class="n">max_df</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> 
                                <span class="n">min_df</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">raw_text</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s">'consumer_complaint_narrative'</span><span class="p">])</span>
<span class="n">raw_text</span><span class="o">.</span><span class="n">consumer_complaint_narrative</span> <span class="o">=</span> <span class="n">raw_text</span><span class="o">.</span><span class="n">consumer_complaint_narrative</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

<span class="n">lda</span> <span class="o">=</span> <span class="n">LatentDirichletAllocation</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c"># one component for each product</span>

<span class="n">encoded</span> <span class="o">=</span> <span class="n">vect</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">raw_text</span><span class="o">.</span><span class="n">consumer_complaint_narrative</span><span class="p">[</span><span class="n">raw_text</span><span class="o">.</span><span class="n">relief_received</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">10000</span><span class="p">))</span>
<span class="n">lda</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  self[name] = value
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pyLDAvis.sklearn</span> <span class="kn">import</span> <span class="n">prepare</span>
<span class="kn">import</span> <span class="nn">pyLDAvis</span>

<span class="n">vis</span> <span class="o">=</span> <span class="n">prepare</span><span class="p">(</span><span class="n">lda</span><span class="p">,</span> <span class="n">encoded</span><span class="p">,</span> <span class="n">vect</span><span class="p">,</span>
<span class="c">#               mds='tsne'</span>
             <span class="p">)</span>

<span class="n">pyLDAvis</span><span class="o">.</span><span class="n">enable_notebook</span><span class="p">()</span>

<span class="n">pyLDAvis</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>


</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">topics</span> <span class="o">=</span> <span class="n">lda</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
<span class="n">text_with_topics</span> <span class="o">=</span> <span class="n">raw_text</span><span class="p">[</span><span class="n">raw_text</span><span class="o">.</span><span class="n">relief_received</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">text_with_topics</span><span class="p">[</span><span class="s">'top_topic'</span><span class="p">]</span> <span class="o">=</span> <span class="n">topics</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">text_with_topics</span><span class="p">[</span><span class="s">'top_topic_prob'</span><span class="p">]</span> <span class="o">=</span> <span class="n">topics</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">text_with_topics</span><span class="o">.</span><span class="n">top_topic</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">text_with_topics</span><span class="p">[</span><span class="s">'issue'</span><span class="p">],</span> <span class="n">text_with_topics</span><span class="o">.</span><span class="n">top_topic</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n_samples</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">n_features</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">n_components</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">n_top_words</span> <span class="o">=</span> <span class="mi">20</span>


<span class="k">def</span> <span class="nf">print_top_words</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">n_top_words</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">topic_idx</span><span class="p">,</span> <span class="n">topic</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">components_</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">"Topic #</span><span class="si">%</span><span class="s">d: "</span> <span class="o">%</span> <span class="n">topic_idx</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="s">" "</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">topic</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[:</span><span class="o">-</span><span class="n">n_top_words</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">print</span><span class="p">()</span>
    
<span class="n">print_top_words</span><span class="p">(</span><span class="n">lda</span><span class="p">,</span> <span class="n">vect</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(),</span> <span class="n">n_top_words</span><span class="p">)</span>

</code></pre></div></div>

  </div>

</article>

<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">TMS - Data Person</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>TMS - Data Person</li>
          <li><a href="mailto:tmerrittsmith@gmail.com">tmerrittsmith@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/tmerrittsmith"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">tmerrittsmith</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/tmrtsmith"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">tmrtsmith</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
